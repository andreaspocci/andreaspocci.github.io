<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meteo Sant’Antonino</title>
  <style>
    :root{
      --bg1:#070b17; --bg2:#101a35;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.085);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.45);
      --shadow: 0 20px 80px rgba(0,0,0,.55);
      --r: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 700px at 15% 10%, #1a2f6b 0%, transparent 60%),
        radial-gradient(900px 600px at 85% 25%, #5a2b7a 0%, transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .wrap{max-width:1200px; margin:28px auto; padding:0 16px}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:18px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:#ff5a5a; box-shadow:0 0 0 6px rgba(255,90,90,.12);
    }
    .title{display:flex; flex-direction:column; line-height:1.1}
    .title .h{font-size:14px}
    .title .s{font-size:12px; color:var(--muted)}
    .pills{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{
      padding:10px 12px; border-radius:999px; background:var(--card);
      border:1px solid var(--stroke); color:var(--muted); font-size:12px;
      backdrop-filter: blur(10px);
    }
    .pill .v{color:var(--text); font-weight:600}
    .grid{display:grid; grid-template-columns: 1.35fr .65fr; gap:16px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }

    .panel{
      border-radius:var(--r);
      background: linear-gradient(180deg, var(--card2), var(--card));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      padding:18px;
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(14px);
    }
    .panel:before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(600px 300px at 40% 0%, rgba(255,255,255,.10), transparent 60%);
      pointer-events:none;
    }

    .hero{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      align-items:center;
      min-height:240px;
    }
    @media (max-width: 720px){ .hero{grid-template-columns:1fr} }

    .temp{font-size:68px; letter-spacing:-1px; margin:0}
    .sub{margin-top:6px; color:var(--muted); font-size:14px}
    .statusline{margin-top:10px; color:var(--muted2); font-size:12px}

    .kpiRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .kpi{
      padding:10px 12px; border-radius:16px; background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      min-width:150px;
    }
    .kpi .l{font-size:12px; color:var(--muted)}
    .kpi .v{font-size:18px; color:var(--text); margin-top:4px}

    .wxIcon{
      width:150px; height:150px; margin-left:auto; margin-right:10px;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,.5));
      opacity:.95;
    }

    .sectionTitle{font-size:13px; color:var(--muted); margin:0 0 10px 0}

    .forecastRow{display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:10px}
    @media (max-width: 920px){ .forecastRow{grid-template-columns: repeat(3, minmax(0,1fr));} }
    .fcell{
      padding:12px; border-radius:18px; background:rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      text-align:center;
    }
    .fcell .t{font-size:12px; color:var(--muted)}
    .fcell .v{font-size:18px; margin-top:6px}
    .fcell svg{width:36px;height:36px;margin-top:10px;opacity:.9}

    .miniGrid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:8px}
    .mini{
      padding:12px; border-radius:18px; background:rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
    }
    .mini .l{font-size:12px; color:var(--muted)}
    .mini .v{font-size:18px; margin-top:6px}

    .warn{
      margin-top:10px; padding:10px 12px; border-radius:16px;
      border:1px solid rgba(255,180,0,.35);
      background: rgba(255,180,0,.12);
      color: rgba(255,255,255,.88);
      font-size:12px;
      display:none;
      word-break: break-word;
    }

    .err{
      margin-top:10px; padding:10px 12px; border-radius:16px;
      border:1px solid rgba(255,90,90,.35);
      background: rgba(255,90,90,.12);
      color: rgba(255,255,255,.88);
      font-size:12px;
      display:none;
      word-break: break-word;
    }

    .debug{
      margin-top:12px; color:rgba(255,255,255,.35); font-size:11px;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot" id="dot"></div>
        <div class="title">
          <div class="h">Meteo Sant’Antonino</div>
          <div class="s">Stazione + previsione</div>
        </div>
      </div>
      <div class="pills">
        <div class="pill">Ora <span class="v" id="nowTime">--:--</span></div>
        <div class="pill">Data <span class="v" id="nowDate">--</span></div>
        <div class="pill">Stato <span class="v" id="stateTxt">--</span></div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="hero">
          <div>
            <div class="sub" id="headline">Caricamento...</div>
            <h1 class="temp" id="tempMain">--°</h1>
            <div class="sub" id="feelsLine">--</div>
            <div class="statusline" id="updatedLine">--</div>

            <div class="warn" id="warnBox"></div>
            <div class="err" id="errBox"></div>

            <div class="kpiRow">
              <div class="kpi"><div class="l">Umidità</div><div class="v" id="hum">--%</div></div>
              <div class="kpi"><div class="l">Vento</div><div class="v" id="wind">-- km/h</div></div>
              <div class="kpi"><div class="l">Pressione</div><div class="v" id="press">-- hPa</div></div>
              <div class="kpi"><div class="l">Pioggia oggi</div><div class="v" id="rain">-- mm</div></div>
            </div>
          </div>

          <div style="display:flex; justify-content:flex-end;">
            <div id="iconHolder"></div>
          </div>
        </div>

        <div style="margin-top:14px;">
          <p class="sectionTitle">Prossime ore</p>
          <div class="forecastRow" id="forecastRow"></div>
        </div>

        <div class="debug" id="debugLine"></div>
      </div>

      <div class="panel">
        <p class="sectionTitle">Dettagli</p>
        <div class="miniGrid">
          <div class="mini"><div class="l">Rugiada</div><div class="v" id="dew">-- °C</div></div>
          <div class="mini"><div class="l">Raffica</div><div class="v" id="gust">-- km/h</div></div>
          <div class="mini"><div class="l">Direzione vento</div><div class="v" id="wdir">--</div></div>
          <div class="mini"><div class="l">UV</div><div class="v" id="uv">--</div></div>
          <div class="mini"><div class="l">Insolazione</div><div class="v" id="sol">-- W/m²</div></div>
          <div class="mini"><div class="l">VPD</div><div class="v" id="vpd">-- inHg</div></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const WORKER_BASE = "https://dry-frog-bb05.spocci.workers.dev";
  const ENDPOINT_NOW = WORKER_BASE.replace(/\/$/, "") + "/station/now";
  const ENDPOINT_FORECAST = WORKER_BASE.replace(/\/$/, "") + "/forecast";

  const el = (id) => document.getElementById(id);

  function fmt1(n){ return (Math.round(n * 10) / 10).toFixed(1); }
  function safeNum(v){
    if (v === null || v === undefined) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function showWarn(msg){
    const w = el("warnBox");
    w.textContent = msg;
    w.style.display = "block";
  }
  function hideWarn(){ el("warnBox").style.display = "none"; }

  function showErr(msg){
    const e = el("errBox");
    e.textContent = msg;
    e.style.display = "block";
  }
  function hideErr(){ el("errBox").style.display = "none"; }

  function setOnline(isOnline){
    el("stateTxt").textContent = isOnline ? "Online" : "Offline";
    const dot = el("dot");
    dot.style.background = isOnline ? "#34d399" : "#ff5a5a";
    dot.style.boxShadow = isOnline ? "0 0 0 6px rgba(52,211,153,.12)" : "0 0 0 6px rgba(255,90,90,.12)";
  }

  function windDirText(deg){
    const d = safeNum(deg);
    if (d === null) return "--";
    const dirs = ["N","NE","E","SE","S","SW","W","NW"];
    const idx = Math.round(((d % 360) / 45)) % 8;
    return `${Math.round(d)}° ${dirs[idx]}`;
  }

  function iconSvg(kind, large=true){
    const cls = large ? 'class="wxIcon"' : '';
    const cloud = `
      <svg ${cls} viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M44 90h49c14 0 25-10 25-23s-11-23-25-23c-3 0-6 1-9 2C80 32 68 22 53 22 36 22 22 36 22 53c0 2 0 4 1 6C13 63 6 72 6 82c0 13 11 23 24 23h14Z" stroke="rgba(255,255,255,.92)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;
    const sun = `
      <svg ${cls} viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="64" cy="64" r="22" stroke="rgba(255,255,255,.92)" stroke-width="6"/>
        <path d="M64 10v14M64 104v14M10 64h14M104 64h14M24 24l10 10M94 94l10 10M104 24l-10 10M34 94l-10 10" stroke="rgba(255,255,255,.92)" stroke-width="6" stroke-linecap="round"/>
      </svg>`;
    const rain = `
      <svg ${cls} viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M44 78h49c14 0 25-10 25-23s-11-23-25-23c-3 0-6 1-9 2C80 20 68 10 53 10 36 10 22 24 22 41c0 2 0 4 1 6C13 51 6 60 6 70c0 13 11 23 24 23h14Z" stroke="rgba(255,255,255,.92)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M42 92l-6 16M64 92l-6 16M86 92l-6 16" stroke="rgba(255,255,255,.92)" stroke-width="6" stroke-linecap="round"/>
      </svg>`;
    if(kind === "sun") return sun;
    if(kind === "rain") return rain;
    return cloud;
  }

  function pickKindFromStation(sample){
    const rainRate = safeNum(sample?.rain?.rateMmH);
    const solar = safeNum(sample?.solar?.solarWm2);

    // se il dato manca, non fingere uno stato meteo
    if (rainRate === null && solar === null) return "cloud";

    if (rainRate !== null && rainRate > 0.2) return "rain";
    if (solar !== null && solar > 180) return "sun";
    return "cloud";
  }

  function setTextOrDash(nodeId, valueText){
    el(nodeId).textContent = valueText;
  }

  function resetUI(){
    el("headline").textContent = "Dati non disponibili";
    el("tempMain").textContent = "--°";
    el("feelsLine").textContent = "--";
    el("updatedLine").textContent = "--";

    setTextOrDash("hum", "--%");
    setTextOrDash("wind", "-- km/h");
    setTextOrDash("press", "-- hPa");
    setTextOrDash("rain", "-- mm");

    setTextOrDash("dew", "-- °C");
    setTextOrDash("gust", "-- km/h");
    setTextOrDash("wdir", "--");
    setTextOrDash("uv", "--");
    setTextOrDash("sol", "-- W/m²");
    setTextOrDash("vpd", "-- inHg");

    el("iconHolder").innerHTML = iconSvg("cloud", true);
  }

  function renderStation(payload, sourceLabel){
    const sample = payload?.sample || payload;

    const t = safeNum(sample?.outdoor?.tempC);
    const feels = safeNum(sample?.outdoor?.feelsLikeC);
    const app = safeNum(sample?.outdoor?.appTempC);

    const hum = safeNum(sample?.outdoor?.humidity);
    const dew = safeNum(sample?.outdoor?.dewPointC);
    const vpd = safeNum(sample?.outdoor?.vpdInHg);

    const ws = safeNum(sample?.wind?.speedKmh);
    const gust = safeNum(sample?.wind?.gustKmh);
    const wdir = safeNum(sample?.wind?.directionDeg);

    const press = safeNum(sample?.pressure?.relativeHpa);
    const sol = safeNum(sample?.solar?.solarWm2);
    const uv = safeNum(sample?.solar?.uvi);

    const rainDaily = safeNum(sample?.rain?.dailyMm);

    // criterio: temperatura deve esistere davvero, non “inventata”
    const hasCore = (t !== null);

    setOnline(hasCore);

    const iso = payload?.iso || sample?.iso || null;
    const ts = safeNum(sample?.ts) || safeNum(payload?.ts) || null;

    let updatedStr = "--";
    let ageMin = null;

    if (iso) {
      const dt = new Date(iso);
      if (!Number.isNaN(dt.getTime())) {
        updatedStr = dt.toLocaleString("it-CH");
        ageMin = Math.floor((Date.now() - dt.getTime()) / 60000);
      }
    } else if (ts) {
      const dt = new Date(ts);
      if (!Number.isNaN(dt.getTime())) {
        updatedStr = dt.toLocaleString("it-CH");
        ageMin = Math.floor((Date.now() - dt.getTime()) / 60000);
      }
    }

    el("debugLine").textContent = `now: ${ENDPOINT_NOW} | forecast: ${ENDPOINT_FORECAST}${sourceLabel ? " | src: " + sourceLabel : ""}`;

    if (!hasCore) {
      resetUI();
      el("headline").textContent = "Dati non disponibili";
      el("updatedLine").textContent = `Aggiornato: ${updatedStr}`;
      el("iconHolder").innerHTML = iconSvg("cloud", true);
      return;
    }

    el("headline").textContent = "Ora";
    el("tempMain").textContent = fmt1(t) + "°";

    const feelsTxt = (feels === null) ? "--" : fmt1(feels) + "°";
    const appTxt = (app === null) ? "--" : fmt1(app) + "°";
    el("feelsLine").textContent = `Feels ${feelsTxt} | App ${appTxt}`;

    el("updatedLine").textContent = `Aggiornato: ${updatedStr}`;

    // credibilità: se i dati sono vecchi, lo dici
    hideWarn();
    if (ageMin !== null && ageMin >= 10) {
      showWarn(`Dati non aggiornati da ${ageMin} minuti. Stazione online, ma valore potenzialmente non attuale.`);
    }

    setTextOrDash("hum", hum === null ? "--%" : Math.round(hum) + "%");
    setTextOrDash("wind", ws === null ? "-- km/h" : Math.round(ws) + " km/h");
    setTextOrDash("press", press === null ? "-- hPa" : Math.round(press) + " hPa");
    setTextOrDash("rain", rainDaily === null ? "-- mm" : fmt1(rainDaily) + " mm");

    setTextOrDash("dew", dew === null ? "-- °C" : fmt1(dew) + " °C");
    setTextOrDash("gust", gust === null ? "-- km/h" : Math.round(gust) + " km/h");
    setTextOrDash("wdir", windDirText(wdir));
    setTextOrDash("uv", uv === null ? "--" : fmt1(uv));
    setTextOrDash("sol", sol === null ? "-- W/m²" : Math.round(sol) + " W/m²");
    setTextOrDash("vpd", vpd === null ? "-- inHg" : fmt1(vpd) + " inHg");

    el("iconHolder").innerHTML = iconSvg(pickKindFromStation(sample), true);
  }

  function renderForecast(payload){
    const row = el("forecastRow");
    row.innerHTML = "";

    // supporta più formati, ma non inventa dati
    const hours = payload?.hours || payload?.hourly || payload?.data?.hours || payload?.data || null;

    const arr = Array.isArray(hours) ? hours : null;

    if (!arr || arr.length === 0) {
      for (let i=0;i<6;i++){
        const c = document.createElement("div");
        c.className = "fcell";
        c.innerHTML = `<div class="t">--:--</div>${iconSvg("cloud", false)}<div class="v">--°</div>`;
        row.appendChild(c);
      }
      return;
    }

    arr.slice(0,6).forEach(h => {
      const timeIso = h?.iso || h?.time || h?.datetime || null;
      const t = safeNum(h?.tempC ?? h?.temperatureC ?? h?.temperature ?? h?.temp);
      const rain = safeNum(h?.rainMm ?? h?.precipMm ?? h?.precip ?? h?.rain);
      const solar = safeNum(h?.solarWm2 ?? h?.solar);

      let kind = "cloud";
      // se pioggia/sole mancano, non forzare troppo: lasciamo cloud neutro
      if (rain !== null && rain > 0.2) kind = "rain";
      else if (solar !== null && solar > 180) kind = "sun";

      const label = timeIso
        ? new Date(timeIso).toLocaleTimeString("it-CH",{hour:"2-digit",minute:"2-digit"})
        : "--:--";

      const c = document.createElement("div");
      c.className = "fcell";
      c.innerHTML = `
        <div class="t">${label}</div>
        ${iconSvg(kind, false)}
        <div class="v">${t === null ? "--°" : fmt1(t) + "°"}</div>
      `;
      row.appendChild(c);
    });
  }

  async function fetchJson(url, timeoutMs=9000){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    try{
      const r = await fetch(url, { signal: ctrl.signal, cache:"no-store" });
      if(!r.ok) throw new Error("HTTP " + r.status);
      return await r.json();
    } finally {
      clearTimeout(t);
    }
  }

  function cacheSet(key, value){
    try { localStorage.setItem(key, JSON.stringify({ ts: Date.now(), value })); } catch(_) {}
  }
  function cacheGet(key){
    try {
      const obj = JSON.parse(localStorage.getItem(key) || "null");
      return obj?.value ?? null;
    } catch(_) { return null; }
  }

  async function loadAll(){
    hideErr();

    const d = new Date();
    el("nowTime").textContent = d.toLocaleTimeString("it-CH",{hour:"2-digit",minute:"2-digit"});
    el("nowDate").textContent = d.toLocaleDateString("it-CH",{day:"2-digit",month:"short"});

    // stazione
    let station = null;
    let stationSrc = "live";
    try{
      station = await fetchJson(ENDPOINT_NOW);
      cacheSet("last_good_station", station);
    } catch (e){
      station = cacheGet("last_good_station");
      stationSrc = "cache";
      showErr("Errore rete stazione. Uso ultimo dato salvato.");
      setOnline(false);
    }

    if (station) renderStation(station, stationSrc);
    else resetUI();

    // forecast
    try{
      const fc = await fetchJson(ENDPOINT_FORECAST);
      cacheSet("last_good_forecast", fc);
      renderForecast(fc);
    } catch (e){
      const fc = cacheGet("last_good_forecast");
      if (fc) {
        renderForecast(fc);
        showWarn("Previsione non aggiornata. Uso ultimo forecast salvato.");
      } else {
        renderForecast({});
      }
    }
  }

  resetUI();
  el("iconHolder").innerHTML = iconSvg("cloud", true);
  loadAll();
  setInterval(loadAll, 60_000);
</script>
</body>
</html>
